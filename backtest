import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from stratimplement import RSIstrategy
import yfinance as yf

# Set the RSI period and upper/lower bounds
rsiPeriod = "1y"
rsiInterval = "1d"
rsi_period = 14
rsi_upper = 70
rsi_lower = 30

# Load price data for the stock from Yahoo Finance
stock = 'NVDA'
symbol = yf.Ticker(stock)
df_stock = symbol.history(interval= rsiInterval ,period= rsiPeriod)

# Instantiate the RSI strategy object
rsi_strategy = RSIstrategy('NVDA', df_stock)

# Generate signals
signals_df = rsi_strategy.generate_signals()

# Combine price and signal dataframes
data_df = pd.concat([df_stock , signals_df], axis=1)

# Backtest the strategy
data_df['positions'] = data_df['positions'].shift(1)
data_df['returns'] = np.log(data_df['Close'] / data_df['Close'].shift(1))
data_df['strategy_returns'] = data_df['returns'] * data_df['positions']
cumulative_strategy_returns = np.exp(data_df['strategy_returns'].cumsum())

# Plot the backtested strategy returns
fig, ax = plt.subplots(figsize=(10, 5))
cumulative_strategy_returns.plot(ax=ax)
ax.set_xlabel('Date')
ax.set_ylabel('Cumulative Strategy Returns')
ax.set_title('Backtesting RSI Strategy on AAPL')
plt.show()
